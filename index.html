<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸¸å¤ªæ¤œçŸ¥Doubsta v1.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b4513">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="ä¸¸å¤ªDoubsta">
    <link rel="apple-touch-icon" href="icon-512.png">

    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body { font-family: -apple-system, sans-serif; padding: 10px; background: #fdf5e6; color: #333; margin: 0; padding-bottom: 40px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #8b4513; margin-bottom: 10px; padding-bottom: 5px; }
        h2 { margin: 0; font-size: 1.1em; color: #5d4037; }
        .settings-btn { background: #6c757d; color: white; padding: 6px 12px; font-size: 0.85em; border-radius: 20px; border: none; cursor: pointer; }

        /* --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ --- */
        .tab-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: #fff; cursor: pointer; opacity: 0.5; transition: 0.3s; }
        .tab-voice { background: #8b4513; } /* èŒ¶è‰² */
        .tab-calc { background: #2e7d32; }  /* ç·‘è‰² */
        .tab-active { opacity: 1; transform: scale(1.02); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- å…±é€šå…¥åŠ›ã‚¨ãƒªã‚¢ --- */
        .input-row { margin-bottom: 12px; }
        .label-group { display: flex; align-items: baseline; margin-bottom: 4px; }
        .label-group label { width: 100px; font-size: 0.9em; font-weight: bold; color: #5d4037; }
        .guide { font-size: 0.75em; color: #795548; }
        input, select { width: 100%; padding: 12px; border: 1px solid #d7ccc8; border-radius: 6px; font-size: 16px; box-sizing: border-box; background: white; }
        input[readonly] { background-color: #f0f0f0; color: #555; font-weight: bold; }

        /* --- éŸ³å£°ãƒ¢ãƒ¼ãƒ‰ç”¨ --- */
        #voiceStatus { font-size: 0.9em; color: white; background: #999; padding: 8px 12px; border-radius: 20px; display: inline-block; margin-bottom: 10px;}
        .listening { background: #d32f2f !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        .voice-btn-group { display: flex; gap: 8px; margin-top: 15px; }
        .voice-btn-group button { flex: 1; padding: 15px; border: none; border-radius: 6px; font-weight: bold; color: white; font-size: 1rem; }
        .btn-mic { background: #8b4513; }
        .btn-save { background: #5d4037; }
        .btn-cancel { background: #999; }

        /* --- é›»å“ãƒ¢ãƒ¼ãƒ‰ç”¨ (å¤§å‹UI) --- */
        .calc-display-area { background: #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; text-align: right; border: 2px solid #ccc; }
        .calc-label { font-size: 0.8rem; color: #666; display: block; text-align: left; }
        .calc-value { font-size: 2.5rem; font-weight: bold; color: #333; font-family: monospace; }
        
        /* æé•·ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .length-control { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: #fff; padding: 5px; border-radius: 8px; border: 1px solid #ddd; }
        .length-btn { width: 60px; height: 50px; font-size: 1.5rem; background: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; color: #333; }
        .length-display { flex: 1; text-align: center; font-size: 1.8rem; font-weight: bold; color: #2e7d32; }

        /* ãƒ†ãƒ³ã‚­ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */
        .numpad { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
        .num-btn { padding: 20px 0; font-size: 1.8rem; border: none; border-radius: 8px; background: white; box-shadow: 0 2px 0 #ccc; color: #333; font-weight: bold; }
        .num-btn:active { transform: translateY(2px); box-shadow: none; background: #eee; }
        
        .btn-clr { background: #ef5350; color: white; }
        .btn-save-large { grid-column: span 2; background: #2e7d32; color: white; font-size: 1.5rem; }
        
        /* --- ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ & è¨­å®š --- */
        .summary-box { display: flex; justify-content: space-between; background: #efebe9; padding: 10px; border-radius: 8px; margin: 20px 0 10px; font-weight: bold; color: #5d4037; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #d7ccc8; padding: 8px 4px; text-align: center; }
        th { background: #efebe9; }
        .btn-del { background: #d32f2f; color: white; border: none; padding: 4px 8px; border-radius: 4px; }
        .export-btn { width: 100%; background: #388e3c; color: white; padding: 12px; border: none; border-radius: 6px; margin-top: 10px; font-size: 1rem; font-weight: bold; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 85%; max-width: 400px; border-radius: 12px; }
        .close-btn { background: #666; color: white; width: 100%; padding: 10px; border: none; border-radius: 6px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <div class="header-area">
        <h2>ğŸŒ² ä¸¸å¤ªæ¤œçŸ¥ Doubsta</h2>
        <button class="settings-btn" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
    </div>

    <div class="tab-group">
        <button class="tab-btn tab-voice tab-active" id="tabVoice" onclick="switchMode('voice')">ğŸ™ï¸ éŸ³å£°å…¥åŠ›</button>
        <button class="tab-btn tab-calc" id="tabCalc" onclick="switchMode('calc')">ğŸ”¢ é›»å“å…¥åŠ›</button>
    </div>

    <div id="viewVoice">
        <div id="voiceStatus">éŸ³å£°å…¥åŠ›ï¼šå¾…æ©Ÿä¸­</div>
        
        <div class="input-row">
            <div class="label-group"><label>æ¨¹ç¨®</label></div>
            <select id="v_treeType" class="tree-selector"></select>
        </div>
        <div class="input-row">
            <div class="label-group"><label>æé•· (m)</label></div>
            <input type="number" id="v_length" value="4">
        </div>
        <div class="input-row">
            <div class="label-group"><label>æœ«å£ (cm)</label></div>
            <input type="number" id="v_diameter">
        </div>
        <div class="input-row">
            <div class="label-group"><label>å‚™è€ƒ</label></div>
            <input type="text" id="v_memo">
        </div>

        <div class="voice-btn-group">
            <button class="btn-mic" onclick="toggleMic()">ğŸ¤ é–‹å§‹/åœæ­¢</button>
            <button class="btn-save" onclick="saveData('voice')">ä¿å­˜</button>
            <button class="btn-cancel" onclick="clearVoiceForm()">ã‚¯ãƒªã‚¢</button>
        </div>
        <p class="guide" style="text-align:center; margin-top:10px;">â€»ã€Œã™ãã€ã€Œç›´å¾„24ã€ã€Œä¿å­˜ã€ãªã©ã¨ç™ºè©±</p>
    </div>

    <div id="viewCalc" style="display:none;">
        <div style="margin-bottom:10px;">
            <label class="calc-label">æ¨¹ç¨®ã‚’é¸æŠ</label>
            <select id="c_treeType" class="tree-selector" style="font-size:1.2rem; padding:10px;"></select>
        </div>

        <div class="length-control">
            <button class="length-btn" onclick="addLength(-0.5)">ï¼</button>
            <div class="length-display"><span id="c_length_disp">4.0</span> m</div>
            <button class="length-btn" onclick="addLength(0.5)">ï¼‹</button>
        </div>

        <div class="calc-display-area" onclick="clearCalc()">
            <span class="calc-label">æœ«å£ç›´å¾„ (cm)</span>
            <div id="c_diameter_disp" class="calc-value">0</div>
        </div>

        <div class="numpad">
            <button class="num-btn" onclick="numInput(7)">7</button>
            <button class="num-btn" onclick="numInput(8)">8</button>
            <button class="num-btn" onclick="numInput(9)">9</button>
            <button class="num-btn btn-clr" onclick="clearCalc()">C</button>

            <button class="num-btn" onclick="numInput(4)">4</button>
            <button class="num-btn" onclick="numInput(5)">5</button>
            <button class="num-btn" onclick="numInput(6)">6</button>
            <button class="num-btn" onclick="numInput('BS')">âŒ«</button>

            <button class="num-btn" onclick="numInput(1)">1</button>
            <button class="num-btn" onclick="numInput(2)">2</button>
            <button class="num-btn" onclick="numInput(3)">3</button>
            <button class="num-btn btn-save-large" style="grid-row: span 2;" onclick="saveData('calc')">ä¿å­˜</button>

            <button class="num-btn" onclick="numInput(0)" style="grid-column: span 2;">0</button>
            </div>
    </div>

</div>

<div class="card">
    <div class="summary-box">
        <div>æœ¬æ•°: <span id="totalCount">0</span> æœ¬</div>
        <div>æç©: <span id="totalVolume">0.000</span> m3</div>
    </div>
    <div class="table-container">
        <table id="dataTable">
            <thead><tr><th>æ¨¹ç¨®</th><th>é•·</th><th>å¾„</th><th>æç©</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
    <button class="export-btn" onclick="handleExport()">CSVå‡ºåŠ›</button>
    <div style="text-align:right; margin-top:10px;">
        <button class="btn-del" style="background:#666;" onclick="handleAllClear()">å…¨æ¶ˆå»</button>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <div class="header-area"><h3>è¨­å®š</h3></div>
        <label>è¿½åŠ æ¨¹ç¨® (æœ€å¤§5ã¤)</label>
        <div id="customTreeInputs"></div>
        <button class="export-btn" onclick="saveSettings()" style="margin-top:15px; background:#5d4037;">è¨­å®šä¿å­˜</button>
        <button class="close-btn" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    const STORAGE_KEY = 'timber_doubsta_data';
    const SETTINGS_KEY = 'timber_doubsta_settings';
    const DEFAULT_TREES = ['ã‚¹ã‚®', 'ãƒ’ãƒã‚­', 'ä»–é‡', 'ä»–åºƒ'];
    
    let currentSettings = { customTrees: [] };
    let currentMode = 'voice'; // 'voice' or 'calc'
    
    // é›»å“ç”¨ã‚¹ãƒ†ãƒ¼ãƒˆ
    let calcDiameterStr = "";
    let calcLength = 4.0;

    // --- åˆæœŸåŒ– ---
    window.onload = function() {
        loadSettings();
        renderTable();
        
        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®å…¥åŠ›æ¬„ç”Ÿæˆ
        const container = document.getElementById('customTreeInputs');
        for(let i=1; i<=5; i++){
            container.innerHTML += `<input type="text" id="customTree${i}" placeholder="è¿½åŠ ${i}" style="margin-bottom:5px;">`;
        }
        
        // éŸ³å£°èªè­˜åˆæœŸåŒ– (Web Speech API)
        initVoice();
    };

    // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ---
    function switchMode(mode) {
        currentMode = mode;
        const vView = document.getElementById('viewVoice');
        const cView = document.getElementById('viewCalc');
        const tVoice = document.getElementById('tabVoice');
        const tCalc = document.getElementById('tabCalc');

        if(mode === 'voice') {
            vView.style.display = 'block';
            cView.style.display = 'none';
            tVoice.classList.add('tab-active');
            tCalc.classList.remove('tab-active');
        } else {
            vView.style.display = 'none';
            cView.style.display = 'block';
            tVoice.classList.remove('tab-active');
            tCalc.classList.add('tab-active');
        }
    }

    // --- å…±é€šãƒ­ã‚¸ãƒƒã‚¯: ä¿å­˜ ---
    function saveData(source) {
        let tree, len, dia, memo = "";

        if (source === 'voice') {
            tree = document.getElementById('v_treeType').value;
            len = parseFloat(document.getElementById('v_length').value);
            dia = parseFloat(document.getElementById('v_diameter').value);
            memo = document.getElementById('v_memo').value;
        } else {
            tree = document.getElementById('c_treeType').value;
            len = calcLength;
            dia = parseFloat(calcDiameterStr);
            memo = ""; // é›»å“ãƒ¢ãƒ¼ãƒ‰ã¯ãƒ¡ãƒ¢ãªã—
        }

        if (!len || !dia) {
            alert("æé•·ã¾ãŸã¯ç›´å¾„ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“");
            return;
        }

        // æç©è¨ˆç®— (JASä¸¸ã‚ãªã—ã®ç°¡æ˜“è¨ˆç®—: å°æ•°3ä½)
        // å¿…è¦ãªã‚‰ã“ã“ã«JASãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
        let vol = 0;
        if (len < 6) {
            vol = (dia * dia * len) / 10000;
        } else {
            const L_prime = Math.floor(len);
            const factor = dia + (L_prime - 4) / 2;
            vol = (factor * factor * len) / 10000;
        }
        vol = Math.round(vol * 1000) / 1000;

        // ä¿å­˜
        const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        list.unshift({
            id: Date.now(),
            tree: tree,
            length: len,
            diameter: dia,
            volume: vol,
            memo: memo,
            mode: source // ã©ã¡ã‚‰ã®ãƒ¢ãƒ¼ãƒ‰ã§å…¥åŠ›ã—ãŸã‹è¨˜éŒ²
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢ & å†æç”»
        if (source === 'voice') {
            document.getElementById('v_diameter').value = "";
            document.getElementById('v_memo').value = "";
        } else {
            clearCalc();
        }
        renderTable();
    }

    function renderTable() {
        const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        let totalC = 0, totalV = 0;

        list.forEach(item => {
            totalC++;
            totalV += item.volume;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.tree}</td>
                <td>${item.length}</td>
                <td>${item.diameter}</td>
                <td>${item.volume.toFixed(3)}</td>
                <td><button class="btn-del" onclick="deleteItem(${item.id})">Ã—</button></td>
            `;
            tbody.appendChild(row);
        });
        document.getElementById('totalCount').innerText = totalC;
        document.getElementById('totalVolume').innerText = totalV.toFixed(3);
    }

    function deleteItem(id) {
        if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        let list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        list = list.filter(i => i.id !== id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        renderTable();
    }

    function handleAllClear() {
        if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) return;
        localStorage.removeItem(STORAGE_KEY);
        renderTable();
    }

    // --- é›»å“ãƒ­ã‚¸ãƒƒã‚¯ ---
    function numInput(num) {
        if (num === 'BS') {
            calcDiameterStr = calcDiameterStr.slice(0, -1);
        } else {
            // æ–‡å­—åˆ—ã¨ã—ã¦é€£çµï¼ˆ3æ¡ã¾ã§åˆ¶é™ãªã©å¥½ã¿ã§ï¼‰
            if (calcDiameterStr.length < 3) {
                calcDiameterStr += num;
            }
        }
        // è¡¨ç¤ºæ›´æ–°
        const display = document.getElementById('c_diameter_disp');
        display.innerText = calcDiameterStr === "" ? "0" : calcDiameterStr;
    }

    function clearCalc() {
        calcDiameterStr = "";
        document.getElementById('c_diameter_disp').innerText = "0";
    }

    function addLength(val) {
        calcLength += val;
        if(calcLength < 0.5) calcLength = 0.5; // æœ€ä½å€¤
        document.getElementById('c_length_disp').innerText = calcLength.toFixed(1);
    }

    // --- è¨­å®šé–¢é€£ ---
    function openSettings() {
        for(let i=1; i<=5; i++){
            document.getElementById(`customTree${i}`).value = currentSettings.customTrees[i-1] || "";
        }
        document.getElementById('settingsModal').style.display = 'block';
    }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    
    function saveSettings() {
        let newTrees = [];
        for(let i=1; i<=5; i++){
            const val = document.getElementById(`customTree${i}`).value.trim();
            if(val) newTrees.push(val);
        }
        currentSettings.customTrees = newTrees;
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(currentSettings));
        updateTreeSelectors();
        closeSettings();
    }

    function loadSettings() {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if(saved) currentSettings = JSON.parse(saved);
        updateTreeSelectors();
    }

    function updateTreeSelectors() {
        const options = [...DEFAULT_TREES, ...currentSettings.customTrees];
        const selectors = document.querySelectorAll('.tree-selector');
        selectors.forEach(sel => {
            const currentVal = sel.value;
            sel.innerHTML = "";
            options.forEach(t => {
                const op = document.createElement('option');
                op.value = t; op.text = t;
                sel.appendChild(op);
            });
            if(options.includes(currentVal)) sel.value = currentVal;
        });
    }

    function handleExport() {
        const list = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        if(list.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        
        let csv = "\ufeffæ¨¹ç¨®,æé•·,æœ«å£ç›´å¾„,æç©,å‚™è€ƒ\n";
        list.forEach(i => {
            csv += `${i.tree},${i.length},${i.diameter},${i.volume},${i.memo}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const now = new Date();
        const fname = `ä¸¸å¤ªæ¤œçŸ¥Doubsta-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.csv`;
        
        a.href = url;
        a.download = fname;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 100);
    }

    // --- éŸ³å£°èªè­˜ (Web Speech API - Online) ---
    let recognition;
    let isMicOn = false;

    function initVoice() {
        if (!window.webkitSpeechRecognition && !window.SpeechRecognition) {
            document.getElementById('voiceStatus').innerText = "éŸ³å£°èªè­˜éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™";
            return;
        }
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new Speech();
        recognition.lang = 'ja-JP';
        recognition.continuous = true;
        
        recognition.onresult = function(event) {
            const last = event.results.length - 1;
            const text = event.results[last][0].transcript;
            document.getElementById('voiceStatus').innerText = "èªè­˜: " + text;
            parseVoice(text);
        };
        recognition.onend = function() {
            if(isMicOn) recognition.start();
        };
    }

    function toggleMic() {
        if(!recognition) return;
        isMicOn = !isMicOn;
        const btn = document.querySelector('.btn-mic');
        const status = document.getElementById('voiceStatus');
        
        if(isMicOn) {
            recognition.start();
            btn.style.background = "#d32f2f";
            btn.innerText = "â–  åœæ­¢";
            status.innerText = "èã„ã¦ã„ã¾ã™...";
            status.classList.add('listening');
        } else {
            recognition.stop();
            btn.style.background = "#8b4513";
            btn.innerText = "ğŸ¤ é–‹å§‹";
            status.innerText = "å¾…æ©Ÿä¸­";
            status.classList.remove('listening');
        }
    }

    function clearVoiceForm() {
        document.getElementById('v_diameter').value = "";
        document.getElementById('v_memo').value = "";
    }

    function parseVoice(text) {
        // ç°¡æ˜“ãƒ‘ãƒ¼ã‚µãƒ¼
        if(text.includes("ä¿å­˜")) { saveData('voice'); return; }
        
        // æ¨¹ç¨®
        const treeSel = document.getElementById('v_treeType');
        if(text.includes("ã™ã")) treeSel.value = "ã‚¹ã‚®";
        else if(text.includes("ã²ã®ã")) treeSel.value = "ãƒ’ãƒã‚­";
        
        // æ•°å­—æŠ½å‡º (ç›´å¾„)
        const nums = text.match(/\d+/g);
        if(nums && (text.includes("ç›´å¾„") || text.includes("ã‚»ãƒ³ãƒ"))) {
            document.getElementById('v_diameter').value = nums[0];
        }
        // é•·ã•
        if(nums && (text.includes("é•·ã•") || text.includes("ãƒ¡ãƒ¼ãƒˆãƒ«"))) {
            document.getElementById('v_length').value = nums[0];
        }
    }
</script>
</body>
</html>
